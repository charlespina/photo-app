<!doctype html>
<html>
    <head>
        <title>Photo App</title>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
        <link href='http://fonts.googleapis.com/css?family=Crete+Round' rel='stylesheet' type='text/css'>
        <link type="text/css" rel="stylesheet" href="css/v1.css">
        <script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>
        <script type="text/javascript" src="js/jquery.transit.min.js"></script>
        <script type="text/javascript" src="js/jquery-ui-1.9.0.custom.min.js"></script>
        <script type="text/javascript">
            $.extend({
                params: function() {
                    var vars = [];
                    var tuples = window.location.href.slice(window.location.href.indexOf('?')+1).split('&');
                    for (var i = 0; i < tuples.length; i++) {
                        var tuple;
                        tuple=tuples[i].split('=');
                        vars[tuple[0]] = tuple[1];
                    }
                    return vars;
                    },
                getParam: function(name, fallback) {
                    var val = $.params()[name];
                    return (val == undefined) ? fallback : val;
                }
            });
        </script>
        <script type="text/javascript">
            var imageCache = {};
            var metadataCache = {};
            var apiKey = "163b09ce67a3c84a8aef760016ea26f6";
            var myId = "63533647@N05";
            var maxPages = 1;
            var nextPage = 1;
            var fetchingImages = false;
            var imageOrder = [];
            var currentImage = 0;
            var columnHeights = [0, 0, 0, 0];

            // grab photos on page load
            $(function() { 
                var setId = $.getParam('set');
                if(setId) {
                    getFlickrSetImages(setId);
                    getFlickrSets("sets", "Other Sets");
                } else {
                    $(".back-to-all").hide();
                    getFlickrSets("photos", "Flickr Photo Stream");
                    getPublicFlickrImages(1);
                }
            });

            // viewer-controls events
            $(function() {
                $("#info").draggable();
                $("#info .exit").click(function() { $("#info").hide(); return false; });
                $(".prev").click(function() { return swapImage(false); });
                $(".next").click(function() { return swapImage(true); });
                $(".info").click(function() { $("#info").toggle(); return false; });
                $(".sizes, .link").click(function() { $("#redirect").toggle(); });

                // key bindings
                $(window).keydown(function(event) {
                    if(! $("#viewer-top-controls").is(":visible"))
                        return true;

                    switch(event.which) {
                        case 88: // x
                        case 120: // X
                        case 27: // esc
                            closeViewer();
                            break;
                        case 37: // left
                            swapImage(false);
                            break;
                        case 39: // right
                            swapImage(true);
                            break;
                    }
                });
            });

            // load more photos when nearish page bottom
            $(window).scroll(function() {
                if(okToFetch() && ($(document).height() - $(window).height() - $(window).scrollTop()) < $(window).height()) {
                    getPublicFlickrImages(nextPage);
                }
            });

            function okToFetch() {
                return (!fetchingImages) && (nextPage <= maxPages);
            }

            function getBestImage(images, widthConstraint, heightConstraint) {
                // choose the first image that is larger than widthConstraint
                if (widthConstraint > 0) {
                    for(var i=0; i<images.length; i++) {
                        if(!images[i].url) continue; // skip images with no payload

                        if(images[i].width >= widthConstraint) {
                            return images[i];
                        }
                    }
                }

                // or last image that is smaller than heightConstraint
                if (heightConstraint > 0) {
                    var lastGoodImage;
                    for(var i=0; i<images.length; i++) {
                        if(!images[i].url) continue;

                        if(images[i].height > heightConstraint ) {
                            break;
                        }

                        lastGoodImage = images[i];
                    }

                    if(lastGoodImage != undefined)
                        return lastGoodImage;
                }

                // or the first image (tiny)
                return images[0];
            }

            function getPublicFlickrImages(page) {
                var params = {
                    method: "flickr.people.getPublicPhotos",
                    extras: "url_s,url_q,url_m,url_n,url_z,url_c,url_l,url_o",
                    page: page,
                    user_id: myId
                };

                getFlickrImagesParams(params);
            }

            function constructPhotoUrl(farm, server, id, secret) {
                return "http://farm"+farm+".staticflickr.com/"+server+"/"+id+"_"+secret+".jpg"
            }

            function calculateDimensions(oWidth, oHeight) {
                var nWidth = 240;
                var nHeight = (oWidth == 240) ? oHeight : Math.floor(oHeight * (nWidth/oWidth)) ;
                return { width: nWidth, height: nHeight };
            }

            function metadataHtml(metadata) {
                if(metadata.length == 0) return "";

                var html = "<dl class='metadata'>";
                for(var k in metadata) {
                    html += "<dt>"+k+"</dt><dd>"+metadata[k]+"</dd>";
                }
                html += "</dl>";

                return html
            }

            function getShortestColumn(imageHeight) {
                var shortestColumn = 0;
                var shortHeight = columnHeights[0];

                for(var i in columnHeights) {
                    if(columnHeights[i] < shortHeight) {
                        shortestColumn = i;
                    }
                }

                columnHeights[shortestColumn] += parseInt(imageHeight) + 40;
                return shortestColumn;
            }

            function getFlickrSets(where, title) {
                where = where == undefined ? "photos" : where;
                title = title == undefined ? "Photo Sets" : title;

                // add set section to page if it isn't there
                if ($("#"+where).length == 0) {
                    $("#content").append($("<div id='"+where+"' class='set' />").append(
                        "<h1>"+title+"</h1>",
                        "<div class='col0 column first-column' />",
                        "<div class='col1 column' />",
                        "<div class='col2 column' />",
                        "<div class='col3 column last-column' />"
                    ));
                }

                callFlickr({
                    method: "flickr.photosets.getList",
                },
                function(data) {
                    var count=0;
                    for(var idx in data.photosets.photoset) {
                        var set = data.photosets.photoset[idx];

                        $("#"+where+" .col" + idx%4).append(
                            $("<div id='set-"+set.id+"' class='image-set' />")
                                .append($("<a href='?set="+set.id+"' />")
                                    .append("<img src='" + 
                                        constructPhotoUrl(set.farm, set.server, set.primary, set.secret) + 
                                        "' ><h2>"+set.title._content+"</h2>" //"<div class='metadata'><h3>"+set.photos+"</h3></div>"
                                        )));
                        count++;
                    }
                });
            }

            function getFlickrSetImages(set) {
                getFlickrImagesParams({
                    method: "flickr.photosets.getPhotos",
                    photoset_id: set,
                    extras: "url_s,url_q,url_m,url_n,url_z,url_c,url_l,url_o"
                });
            }

            function callFlickr(params, callback) {
                var flickrParameters = {
                    api_key: "163b09ce67a3c84a8aef760016ea26f6",
                    format: "json",
                    user_id: myId
                };

                for(var key in params) {
                    flickrParameters[key] = params[key];
                }

                $.ajax({
                    dataType:"jsonp",
                    jsonp: "jsoncallback",
                    type: "GET",
                    cache: true,
                    url: "http://api.flickr.com/services/rest/",
                    data: flickrParameters,
                    success: callback
                });
            }

            function getFlickrImagesParams(params, where, title) {
                where = where == undefined ? "photos" : where;
                title = title == undefined ? "Photos" : title;

                fetchingImages = true;

                if ($("#"+where).length == 0) {
                    $("#content").append($("<div id='"+where+"' class='set' />").append(
                        "<h1>"+title+"</h1>",
                        "<div class='col0 column first-column' />",
                        "<div class='col1 column' />",
                        "<div class='col2 column' />",
                        "<div class='col3 column last-column' />"
                    ));
                }

                callFlickr(params,
                    function(data) {
                        var photos = data.photos ?  data.photos.photo : data.photoset.photo;
                        var screenHeight = $(window).height();

                        for(var i=0; i<photos.length; i++) { 
                            var flickrId = photos[i].id;
                            var photoId = "ph"+flickrId;

                            var choices = [
                                { url: photos[i].url_s, height: photos[i].height_s, width: photos[i].width_s },
                                { url: photos[i].url_n, height: photos[i].height_n, width: photos[i].width_n },
                                { url: photos[i].url_m, height: photos[i].height_m, width: photos[i].width_m },
                                { url: photos[i].url_z, height: photos[i].height_z, width: photos[i].width_z },
                                { url: photos[i].url_c, height: photos[i].height_c, width: photos[i].width_c },
                                { url: photos[i].url_l, height: photos[i].height_l, width: photos[i].width_l },
                                { url: photos[i].url_o, height: photos[i].height_o, width: photos[i].width_o }
                            ];

                            var thumbImage = getBestImage(choices, 240, 0);
                            var bigImage = getBestImage(choices, 0, screenHeight);
                            var dims = calculateDimensions(thumbImage.width, thumbImage.height);

                            var shortestColumn = getShortestColumn(dims.height);

                            $("#"+where+" .col" + shortestColumn).append(
                                $("<div id='"+photoId+"' class='image' style='width: " + dims.width + "px;' />")
                                    /* .hover( function() { $(this).transition({ scale: 1.0375 }, 100, 'snap'); }, 
                                        function() { $(this).transition({ scale: 1 }, 50, 'snap'); }) */
                                    .append($("<a href='"+ bigImage.url +"' assocId='"+flickrId+"' photoIndex='"+imageOrder.length+"' />")
                                        .click(function() { return showImage($(this)); })
                                        .append("<img src='" + thumbImage.url + "' width='"+dims.width+"' height='"+dims.height+"'>")));
                            imageOrder.push(photoId);
                        }
                        fetchingImages = false;
                        maxPages = data.photos ? data.photos.pages : data.photoset.pages;
                        nextPage++;
                    }
                );
            }

            function addImage(img, animLength) {
                animLength = animLength == undefined ? 500 : animLength;
                $("#viewer-image")
                    .removeClass("loading")
                    .append(img)
                    .animate({ width: img.width, height: img.height }, animLength, function() {
                        $(".controls").fadeIn(250);
                        $(img).fadeIn(animLength);
                    });
            }

            function swapImage(forward) {
                var dir = forward ? 1 : -1;
                currentImage = currentImage + dir;
                if (currentImage < 0 || currentImage >= imageOrder.length) {
                    currentImage = currentImage - dir;
                    return false;
                }

                $(".controls").fadeOut(100);
                $("#viewer-image img").detach();
                $("#viewer-image")
                    .addClass("loading");

                showImage($("#"+imageOrder[currentImage]+" a"), false);
                
                return false;
            }

            var metadataOrder = [
                "Model", "FNumber", "ExposureTime", "ISO", "Lens", "DateCreated"
            ];

            var metadataTags = {};
            for(var i in metadataOrder) { 
                metadataTags[metadataOrder[i]] = true;
            }

            function getMetadata(photoId) {
                $(".info-metadata").addClass("loading");
                callFlickr({
                    method: "flickr.photos.getExif",
                    photo_id: photoId
                }, function(data) {
                    var metadata = {};
                    console.log(data);
                    for(var i in data.photo.exif) {
                        var ex = data.photo.exif[i];
                        if(metadataTags[ex.tag]) {
                            metadata[ex.tag] = { label: ex.label, content: ex.raw._content };
                        }
                    }
                    $(".info-metadata").removeClass("loading");
                    addMetadata(photoId, metadata);
                });
            }

            function addMetadata(photoId, metadata) {
                metadataCache[photoId] = metadata;
                for(var i in metadataOrder) {
                    var k = metadataOrder[i];
                    if(!metadata[k]) continue;
                    $(".info-metadata")
                        .append("<dt>"+metadata[k].label+"</dt>")
                        .append("<dd>"+metadata[k].content+"</dd>");
                }
            }

            function showMetadata(photoId) {
                var metadata;

                $(".info-metadata dt, .info-metadata dd").remove();

                if(metadataCache[photoId] == undefined) {
                    getMetadata(photoId);
                    return;
                } 

                addMetadata(photoId, metadataCache[photoId]);
            }

            function showImage(thumb, reset) {
                reset = reset == undefined ? true : reset;
                if(reset) resetViewer();

                var url = thumb.attr("href");
                var photoId = thumb.attr("assocId");
                currentImage = parseInt(thumb.attr("photoIndex"));

                $(".link").attr("href", "http://flickr.com/photos/"+myId+"/"+photoId);
                $(".sizes").attr("href", "http://flickr.com/photos/"+myId+"/"+photoId+"/sizes/l/");

                $("#viewer-image-container").css("margin-top", $(window).scrollTop() + 50);
                $("#overlay").show();
                $("#viewer").show();

                showMetadata(photoId);
                
                if(imageCache[url] != undefined) {
                    var img = imageCache[url];
                    addImage(img, 0);
                    return false;
                }

                var img = new Image();
                $(img)
                    .load(function() {
                        $(img).hide();
                        addImage(img);
                    })
                    .error(function() { console.log("some kind of error (TODO)"); })
                    .attr("src", url);
                
                $("#viewer").show();

                imageCache[url] = img;
                return false;
            }

            function closeViewer() {
                $("#viewer").hide();
                $("#overlay").animate({ opacity: 0 }, 250, resetViewer);
            }

            function resetImage() {
                $("#viewer-image")
                    .addClass("loading")
                    .css("width", 240)
                    .css("height", 240)
                    .show();

                $("#viewer-image img").detach();
                $("#viewer-controls").css({ width: 240 });
            }

            function resetViewer() {
                $("#overlay")
                    .hide()
                    .css("opacity", 1);

                $("#viewer").hide();

                $(".controls").hide();
                resetImage();
            }

            $(function() {
                $("#viewer, #overlay").click(closeViewer);
                $(".image a").click(function() { return showImage($(this)); });
            });
        </script>
    </head>
    <body>
        <div id="overlay"></div>
        <div id="site">
            <div id="viewer">
                <div id="viewer-top-controls" class="controls">
                    <ul>
                        <li><a class='prev' href="#"><img src="icons/resultset_previous.png"><span>previous</span></a></li>
                        <li><a class='sizes' href="#"><img src="icons/magnifier.png"><span>sizes</span></a></li>
                        <li><a class='link' href="#"><img src="icons/photo_link.png"><span>link</span></a></li>
                        <li><a class='info' href="#"><img src="icons/report_picture.png"><span>info</span></a></li>
                        <li class='last-control'><a class='next' href="#"><span>next</span><img src="icons/resultset_next.png"></a></li>
                    </ul>
                </div>
                <div id="viewer-image-container">
                    <div id="info">
                        <div class="exit">X</div>
                        <dl class="info-metadata">
                            <dt>Loading</dt>
                            <dd>Metadata</dd>
                        </dl>
                    </div>
                    <div id="viewer-image">
                    </div>
                </div>
            </div>
            <div id="redirect">
              Sending to Flickr...
            </div>
            <div id="header">
                <div id="header-title">
                <a href="v1.html" class='back-to-all'>
                    <div class='arrow'></div><span>Back to Photo Stream</span>
                </a>
                <h1>
                    <a href="v1.html">ask charl.es / photos</a>
                </h1>
                </div>
            </div>
            <div id="content">
            </div>
            <div id="footer">
                &copy; 2012-2013 Charles Piña
            </div>
        </div>
    </body>
</html>
